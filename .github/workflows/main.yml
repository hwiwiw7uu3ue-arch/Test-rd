name: GOD MODE CLOUD PC

on:
  workflow_dispatch:

jobs:
  cloud-pc:
    runs-on: self-hosted

    steps:

    # =====================================
    # üü¢ SYSTEM STATUS
    # =====================================
    - name: Get System Info
      shell: powershell
      run: |
        $cpu = (Get-Counter '\Processor(_Total)\% Processor Time').CounterSamples.CookedValue
        $ram = (Get-CimInstance Win32_OperatingSystem)
        $ramUsed = [math]::Round(($ram.TotalVisibleMemorySize - $ram.FreePhysicalMemory)/1MB,2)
        $ramTotal = [math]::Round($ram.TotalVisibleMemorySize/1MB,2)

        echo "CPU=$([int]$cpu)" >> $env:GITHUB_ENV
        echo "RAM_USED=$ramUsed" >> $env:GITHUB_ENV
        echo "RAM_TOTAL=$ramTotal" >> $env:GITHUB_ENV

    # =====================================
    # üåê GET TAILSCALE IP
    # =====================================
    - name: Get Private IP
      shell: powershell
      run: |
        $ip = (tailscale ip -4)
        echo "TS_IP=$ip" >> $env:GITHUB_ENV

    # =====================================
    # üì© TELEGRAM CLOUD PC PANEL
    # =====================================
    - name: Send Control Panel Info
      shell: powershell
      run: |
        $time = Get-Date -Format "yyyy-MM-dd HH:mm:ss"

        $msg = @(
        "‚òÅÔ∏è GOD MODE CLOUD PC ONLINE",
        "",
        "üåê Private IP : $env:TS_IP",
        "",
        "üìä SYSTEM STATUS",
        "CPU Usage    : $env:CPU %",
        "RAM Usage    : $env:RAM_USED / $env:RAM_TOTAL GB",
        "",
        "üïí Server Time: $time",
        "",
        "üîê Connect via RDP using Tailscale IP"
        ) -join "`n"

        Invoke-RestMethod `
          -Uri "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" `
          -Method Post `
          -ContentType "application/json" `
          -Body (@{
            chat_id="${{ secrets.TELEGRAM_CHAT_ID }}"
            text=$msg
          } | ConvertTo-Json)

    # =====================================
    # ‚õî OPTIONAL SHUTDOWN CONTROL
    # =====================================
    - name: Wait For Manual Cancel
      shell: powershell
      run: |
        Write-Host "Cloud PC is running. Cancel workflow to stop monitoring."

        while ($true) {
          Start-Sleep -Seconds 300
        }

name: ULTRA RDP

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  ultra-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:

    # =========================================
    # ðŸ”§ Enable RDP
    # =========================================
    - name: Enable RDP
      run: |
        Set-ItemProperty `
          -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
          -Name "fDenyTSConnections" -Value 0

        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Restart-Service TermService -Force

    # =========================================
    # ðŸ” Create Secure User
    # =========================================
    - name: Create RDP User
      run: |
        $chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+'
        $password = -join (1..24 | ForEach-Object {
          $chars[(Get-Random -Maximum $chars.Length)]
        })

        $secure = ConvertTo-SecureString $password -AsPlainText -Force

        New-LocalUser -Name "RDP" -Password $secure -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "RDP"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"

        echo "RDP_PASS=$password" >> $env:GITHUB_ENV

    # =========================================
    # ðŸŒ Install Tailscale
    # =========================================
    - name: Install Tailscale
      run: |
        Invoke-WebRequest `
          https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi `
          -OutFile ts.msi

        Start-Process msiexec.exe `
          -ArgumentList "/i ts.msi /quiet /norestart" -Wait

    - name: Connect Tailscale
      run: |
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
          --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}

        for ($i=0; $i -lt 30; $i++) {
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          if ($ip) { break }
          Start-Sleep 4
        }

        if (-not $ip) { exit 1 }

        echo "TS_IP=$ip" >> $env:GITHUB_ENV

    # =========================================
    # ðŸ“© Telegram Report (YAML SAFE)
    # =========================================
    - name: Send Telegram Report
      run: |
        $start = Get-Date
        $duration = 6
        $expiry = $start.AddHours($duration)

        $msg = @(
        "ULTRA RDP SESSION READY",
        "",
        "Address   : $env:TS_IP",
        "Username  : RDP",
        "Password  : $env:RDP_PASS",
        "",
        "Start     : $($start.ToString('yyyy-MM-dd HH:mm:ss'))",
        "Expires   : $($expiry.ToString('yyyy-MM-dd HH:mm:ss'))",
        "Duration  : $duration Hours",
        "",
        "Session auto-terminates"
        ) -join "`n"

        Invoke-RestMethod `
          -Uri "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" `
          -Method Post `
          -ContentType "application/json" `
          -Body (@{
            chat_id="${{ secrets.TELEGRAM_CHAT_ID }}"
            text=$msg
          } | ConvertTo-Json)

    # =========================================
    # ðŸ“Š ULTRA Dashboard + Animated Expiry
    # =========================================
    - name: Maintain Session (ULTRA)
      run: |
        $start = Get-Date
        $duration = 6
        $expiry = $start.AddHours($duration)

        Write-Host ""
        Write-Host "==========================================="
        Write-Host "         ULTRA RDP SESSION ACTIVE"
        Write-Host "==========================================="
        Write-Host " Address   : $env:TS_IP"
        Write-Host " Username  : RDP"
        Write-Host " Password  : $env:RDP_PASS"
        Write-Host " Started   : $($start.ToString('yyyy-MM-dd HH:mm:ss'))"
        Write-Host " Expires   : $($expiry.ToString('yyyy-MM-dd HH:mm:ss'))"
        Write-Host " Duration  : $duration Hours"
        Write-Host "==========================================="
        Write-Host ""

        while ($true) {
          $now = Get-Date
          $remain = $expiry - $now

          if ($remain.TotalSeconds -le 0) {
            Write-Host ""
            Write-Host "SESSION EXPIRED â€” TERMINATING"
            break
          }

          $h = [int]$remain.TotalHours
          $m = $remain.Minutes
          $s = $remain.Seconds

          Write-Host ("Remaining Time: {0:D2}:{1:D2}:{2:D2}" -f $h,$m,$s)
          Start-Sleep 30
        }
